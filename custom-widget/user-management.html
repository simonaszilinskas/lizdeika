<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Vilnius Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
                    <p class="text-gray-600">Manage users and their roles</p>
                </div>
                <div class="flex gap-3">
                    <a href="agent-dashboard.html" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        ‚Üê Back to Dashboard
                    </a>
                    <button id="cleanup-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-broom"></i>
                        Clean Up Test Users
                    </button>
                    <button id="add-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add New User
                    </button>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">All Users</h2>
                <div class="text-sm text-gray-500">
                    Total Users: <span id="total-users" class="font-medium">Loading...</span>
                </div>
            </div>
            
            <!-- Users Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add New User</h3>
                <button id="close-add-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-user-form">
                <div class="mb-4">
                    <label for="add-first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" id="add-first-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="add-last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="add-last-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="add-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="add-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="add-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="add-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="user">User</option>
                        <option value="agent">Agent</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" id="cancel-add-user" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                        Create User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">New Password Generated</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">A new password has been generated. Copy it now:</p>
                <div class="bg-gray-50 border rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <span id="generated-password" class="font-mono text-lg"></span>
                        <button id="copy-password" class="text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            <button id="close-password-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                Got It
            </button>
        </div>
    </div>

    <!-- Simple JavaScript -->
    <script>
        const API_URL = 'http://localhost:3002';
        let currentUsers = [];

        // Get admin token (you'll need to login first)
        function getToken() {
            return localStorage.getItem('agent_token');
        }

        // Load users
        async function loadUsers() {
            try {
                const token = getToken();
                if (!token) {
                    alert('Please login first');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_URL}/api/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUsers = data.data;
                    renderUsers(currentUsers);
                    document.getElementById('total-users').textContent = currentUsers.length;
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Failed to load users</td></tr>';
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${user.first_name} ${user.last_name}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getRoleColor(user.role)}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm space-x-2">
                        <button onclick="regeneratePassword('${user.id}')" class="text-yellow-600 hover:text-yellow-900" title="Regenerate Password">
                            <i class="fas fa-key"></i>
                        </button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'agent': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Create user
        async function createUser(formData) {
            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    closeModal('add-user-modal');
                    
                    // Show password
                    if (result.data && result.data.password) {
                        document.getElementById('generated-password').textContent = result.data.password;
                        showModal('password-modal');
                    }
                    
                    loadUsers(); // Refresh
                    alert('User created successfully!');
                } else {
                    const error = await response.json();
                    alert('Failed to create user: ' + error.error);
                }
            } catch (error) {
                alert('Failed to create user: ' + error.message);
            }
        }

        // Regenerate password
        async function regeneratePassword(userId) {
            if (!confirm('Generate new password for this user?')) return;

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/api/users/${userId}/regenerate-password`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('generated-password').textContent = result.data.password;
                    showModal('password-modal');
                } else {
                    alert('Failed to regenerate password');
                }
            } catch (error) {
                alert('Failed to regenerate password: ' + error.message);
            }
        }

        // Delete user permanently
        async function deleteUser(userId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to DELETE this user permanently? This cannot be undone!')) return;

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadUsers(); // Refresh
                    alert('User deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Failed to delete user: ' + error.error);
                }
            } catch (error) {
                alert('Failed to delete user: ' + error.message);
            }
        }

        // Clean up test users (agents with random email patterns)
        async function cleanupTestUsers() {
            if (!confirm('‚ö†Ô∏è Delete all test users (agent-* emails and anonymous users)? This will keep only admin@vilnius.lt and agent1-3@vilnius.lt')) return;

            try {
                const testUsers = currentUsers.filter(user => 
                    user.email.includes('agent-') && user.email.includes('@vilnius.lt') ||
                    user.email.includes('anonymous+') ||
                    user.role === 'user' && user.email !== 'admin@vilnius.lt'
                );

                let deleted = 0;
                for (const user of testUsers) {
                    if (user.email === 'admin@vilnius.lt') continue; // Never delete admin
                    
                    try {
                        const token = getToken();
                        const response = await fetch(`${API_URL}/api/users/${user.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) deleted++;
                    } catch (e) {
                        console.log('Failed to delete user:', user.email, e);
                    }
                }

                loadUsers(); // Refresh
                alert(`Deleted ${deleted} test users!`);
            } catch (error) {
                alert('Failed to cleanup users: ' + error.message);
            }
        }

        // Modal functions
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Copy password
        function copyPassword() {
            const password = document.getElementById('generated-password').textContent;
            navigator.clipboard.writeText(password).then(() => {
                alert('Password copied to clipboard!');
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();

            // Add user modal  
            document.getElementById('add-user-btn').onclick = () => showModal('add-user-modal');
            document.getElementById('cleanup-btn').onclick = cleanupTestUsers;
            document.getElementById('close-add-modal').onclick = () => closeModal('add-user-modal');
            document.getElementById('cancel-add-user').onclick = () => closeModal('add-user-modal');

            // Password modal
            document.getElementById('close-password-modal').onclick = () => closeModal('password-modal');
            document.getElementById('copy-password').onclick = copyPassword;

            // Add user form
            document.getElementById('add-user-form').onsubmit = (e) => {
                e.preventDefault();
                const formData = {
                    firstName: document.getElementById('add-first-name').value,
                    lastName: document.getElementById('add-last-name').value,
                    email: document.getElementById('add-email').value,
                    role: document.getElementById('add-role').value
                };
                createUser(formData);
            };
        });
    </script>
</body>
</html>