<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Vilnius Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .system-hitl { background-color: #10b981; }
        .system-autopilot { background-color: #3b82f6; }
        .system-off { background-color: #ef4444; }
        .modal {
            backdrop-filter: blur(4px);
        }
        .admin-only {
            display: none;
        }
        .admin-user .admin-only {
            display: block;
        }

        /* Statistics Styles */
        .statistics-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .statistics-header {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .statistics-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }
        .statistics-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .date-range-picker label {
            font-weight: 500;
            color: #374151;
        }
        .date-range-picker input[type="date"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .date-range-picker input[type="date"]:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .view-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .view-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #374151;
        }
        .view-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 1px 2px 0 rgba(79, 70, 229, 0.2);
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.75rem;
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .stat-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .stat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-header h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .stat-icon-wrapper {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }
        .stat-icon-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        .stat-icon-purple {
            background: #e9d5ff;
            color: #7c3aed;
        }
        .stat-icon-green {
            background: #d1fae5;
            color: #059669;
        }
        .stat-icon-indigo {
            background: #e0e7ff;
            color: #4f46e5;
        }
        .stat-icon-orange {
            background: #fed7aa;
            color: #c2410c;
        }
        .stat-body {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .stat-main-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #111827;
            line-height: 1;
        }
        .stat-breakdown {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .stat-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .stat-badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        .stat-badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        .stat-badge-gray {
            background: #f3f4f6;
            color: #4b5563;
        }
        .stat-subtext {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .stat-subtext i {
            color: #9ca3af;
        }
        .stat-subtext strong {
            color: #374151;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        .stats-table thead {
            background: #f9fafb;
        }
        .stats-table th,
        .stats-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .stats-table th {
            font-weight: 600;
            color: #374151;
        }
        .stat-section {
            margin-bottom: 2rem;
        }
        .stat-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #111827;
        }
        .usage-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        .usage-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .usage-label {
            min-width: 120px;
            font-weight: 500;
        }
        .usage-bar {
            flex: 1;
            height: 24px;
            background: #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            transition: width 0.3s ease;
        }
        .usage-value {
            min-width: 100px;
            text-align: right;
            font-weight: 600;
        }
        .loading-state,
        .error-state {
            text-align: center;
            padding: 3rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-message {
            color: #ef4444;
            margin-bottom: 1rem;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 2FA Reminder Banner -->
    <div id="2fa-reminder-banner" class="hidden bg-yellow-50 border-b border-yellow-200 px-4 py-3">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center gap-3">
                <i class="fas fa-shield-alt text-yellow-600 text-xl"></i>
                <div>
                    <p class="text-sm font-semibold text-yellow-900">Secure your account with Two-Factor Authentication</p>
                    <p class="text-xs text-yellow-700">Add an extra layer of security to protect your account and customer data.</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='setup-2fa.html'" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded-lg transition-colors font-medium">
                    <i class="fas fa-shield-alt mr-2"></i>Set Up Now
                </button>
                <button onclick="dismiss2FAReminder()" class="text-yellow-700 hover:text-yellow-900 text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">System Settings</h1>
                    <p class="text-gray-600">Configure system behavior and manage users</p>
                </div>
                <a href="agent-dashboard.html" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    ← Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Settings Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors active" data-tab="system">
                    <i class="fas fa-cogs mr-1"></i>System
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="agent">
                    <i class="fas fa-user-cog mr-1"></i>Agent
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors admin-only" data-tab="branding">
                    <i class="fas fa-palette mr-1"></i>Branding
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors admin-only" data-tab="context-engineering">
                    <i class="fas fa-brain mr-1"></i>Context
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors admin-only" data-tab="knowledge" id="knowledge-tab">
                    <i class="fas fa-book mr-1"></i>Knowledge
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="categories">
                    <i class="fas fa-tags mr-1"></i>Categories
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors admin-only" data-tab="templates">
                    <i class="fas fa-file-alt mr-1"></i>Templates
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="users">
                    <i class="fas fa-users mr-1"></i>Users
                </button>
                <button class="tab-button px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="statistics">
                    <i class="fas fa-chart-bar mr-1"></i>Statistics
                </button>
            </div>
        </div>

        <!-- System Settings Tab -->
        <div id="system-tab" class="tab-content">
            <!-- System Mode Settings -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-cogs text-indigo-600"></i>
                    Global System Mode
                </h2>
                
                <div class="mb-4">
                    <p class="text-gray-600 mb-4">This setting affects how the system responds to all customer messages across all agents.</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" id="mode-hitl" name="systemMode" value="hitl" class="mr-3">
                            <div class="flex-1">
                                <label for="mode-hitl" class="font-medium text-gray-900 cursor-pointer">
                                    HITL (Human in the Loop)
                                </label>
                                <p class="text-sm text-gray-600">AI generates suggestions that agents must review and approve before sending</p>
                            </div>
                            <div class="w-3 h-3 rounded-full system-hitl" title="HITL Mode"></div>
                        </div>
                        
                        <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" id="mode-autopilot" name="systemMode" value="autopilot" class="mr-3">
                            <div class="flex-1">
                                <label for="mode-autopilot" class="font-medium text-gray-900 cursor-pointer">
                                    Autopilot Mode
                                </label>
                                <p class="text-sm text-gray-600">AI automatically responds to customers with disclaimer messages</p>
                            </div>
                            <div class="w-3 h-3 rounded-full system-autopilot" title="Autopilot Mode"></div>
                        </div>
                        
                        <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" id="mode-off" name="systemMode" value="off" class="mr-3">
                            <div class="flex-1">
                                <label for="mode-off" class="font-medium text-gray-900 cursor-pointer">
                                    OFF Mode
                                </label>
                                <p class="text-sm text-gray-600">System sends offline messages to customers when they write</p>
                            </div>
                            <div class="w-3 h-3 rounded-full system-off" title="OFF Mode"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        Current Mode: <span id="current-mode" class="font-medium">Loading...</span>
                    </div>
                    <button id="save-mode" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg disabled:opacity-50 transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>

        </div>

        <!-- Agent Preferences Tab -->
        <div id="agent-tab" class="tab-content hidden">

            <!-- Other Agent Settings -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-user-cog text-indigo-600"></i>
                    Personal Preferences
                </h2>
                
                <div class="text-gray-600">
                    <p>Additional agent preferences will be added here in future updates.</p>
                </div>
            </div>
        </div>

        <!-- Widget Configuration merged with Branding tab -->

        <!-- Context Engineering Tab -->
        <div id="context-engineering-tab" class="tab-content hidden">
            <!-- RAG Configuration Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-brain text-indigo-600"></i>
                    AI Context Engineering
                </h2>
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-medium mb-1">What is Context Engineering?</p>
                            <p>Fine-tune how the AI retrieves and uses information from your knowledge base. Configure RAG (Retrieval-Augmented Generation) settings and manage specialized prompts for different AI processing stages.</p>
                        </div>
                    </div>
                </div>

                <form id="context-engineering-form" class="space-y-6">
                    <!-- RAG Top-K Setting -->
                    <div>
                        <label for="rag-k" class="block text-sm font-medium text-gray-700 mb-2">
                            Document Retrieval Count (Top-K)
                        </label>
                        <div class="flex items-center gap-4">
                            <input 
                                type="range" 
                                id="rag-k" 
                                name="rag_k" 
                                min="1" 
                                max="200" 
                                value="100" 
                                class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                            >
                            <input 
                                type="number" 
                                id="rag-k-value" 
                                min="1" 
                                max="200" 
                                value="100" 
                                class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            >
                        </div>
                        <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2"><strong>What this does:</strong> Controls how many document chunks the AI retrieves from your knowledge base to answer each question.</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li>• <strong>Lower values (20-50):</strong> Faster responses, more focused answers</li>
                                <li>• <strong>Medium values (50-100):</strong> Balanced performance (recommended)</li>
                                <li>• <strong>Higher values (100-200):</strong> More comprehensive responses</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Similarity Threshold -->
                    <div>
                        <label for="similarity-threshold" class="block text-sm font-medium text-gray-700 mb-2">
                            Similarity Threshold
                        </label>
                        <div class="flex items-center gap-4">
                            <input 
                                type="range" 
                                id="similarity-threshold" 
                                name="rag_similarity_threshold" 
                                min="0.0" 
                                max="1.0" 
                                step="0.05" 
                                value="0.7" 
                                class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                            >
                            <input 
                                type="number" 
                                id="similarity-threshold-value" 
                                min="0.0" 
                                max="1.0" 
                                step="0.05" 
                                value="0.7" 
                                class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            >
                        </div>
                        <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2"><strong>What this does:</strong> Sets minimum similarity score for document relevance.</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li>• <strong>Lower (0.3-0.6):</strong> More permissive, includes loosely related documents</li>
                                <li>• <strong>Medium (0.6-0.8):</strong> Balanced relevance filtering (recommended)</li>
                                <li>• <strong>Higher (0.8-1.0):</strong> Very strict, only highly relevant documents</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Max Context Tokens -->
                    <div>
                        <label for="max-tokens" class="block text-sm font-medium text-gray-700 mb-2">
                            Max Context Tokens
                        </label>
                        <div class="flex items-center gap-4">
                            <input 
                                type="range" 
                                id="max-tokens" 
                                name="rag_max_tokens" 
                                min="500" 
                                max="4000" 
                                step="100" 
                                value="2000" 
                                class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                            >
                            <input 
                                type="number" 
                                id="max-tokens-value" 
                                min="500" 
                                max="4000" 
                                step="100" 
                                value="2000" 
                                class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            >
                        </div>
                        <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2"><strong>What this does:</strong> Limits context information sent to the AI model.</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li>• <strong>Lower (500-1000):</strong> Faster processing, more focused responses</li>
                                <li>• <strong>Medium (1000-2500):</strong> Good balance (recommended)</li>
                                <li>• <strong>Higher (2500-4000):</strong> Maximum context, comprehensive responses</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Save RAG Settings Button -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                        <div id="rag-save-status" class="text-sm text-gray-500"></div>
                        <button 
                            type="submit" 
                            id="save-rag-settings" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2"
                        >
                            <i class="fas fa-save"></i>
                            Save RAG Settings
                        </button>
                    </div>
                </form>
            </div>

            <!-- Simplified Prompt Management Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-code text-purple-600"></i>
                        Prompt Management
                        <span id="langfuse-status-badge" class="ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 hidden">
                            <i class="fas fa-check-circle mr-1"></i>Langfuse Connected
                        </span>
                    </h3>
                </div>

                <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-purple-600 mt-0.5"></i>
                        <div class="text-sm text-purple-800">
                            <p class="font-medium mb-1">Prompt Configuration</p>
                            <p>Choose between using Langfuse-managed prompts or configuring custom prompts directly in this interface.</p>
                        </div>
                    </div>
                </div>

                <!-- Master Toggle -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Prompt Source</h4>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="prompt_mode" value="langfuse" id="mode-langfuse" class="mr-3">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Use Langfuse Prompts</div>
                                <div class="text-sm text-gray-600">Assign existing Langfuse prompts to system roles (system, processing, formatting)</div>
                            </div>
                            <i class="fas fa-cloud text-blue-600"></i>
                        </label>
                        
                        <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="prompt_mode" value="local" id="mode-local" class="mr-3">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Use Local Prompts</div>
                                <div class="text-sm text-gray-600">Configure and edit prompts directly in this settings interface</div>
                            </div>
                            <i class="fas fa-edit text-green-600"></i>
                        </label>
                    </div>
                </div>

                <!-- Langfuse Mode Configuration -->
                <div id="langfuse-config" class="space-y-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Langfuse Prompt Assignment</h4>
                    
                    <!-- System Prompt Assignment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-robot text-blue-600 mr-1"></i>System Prompt
                        </label>
                        <div class="mb-2 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <p class="text-sm text-blue-800"><strong>Role:</strong> Sets the AI's core identity, behavior, and capabilities</p>
                            <p class="text-xs text-blue-600 mt-1">Defines who the AI is and how it should behave. Uses <code>{context}</code> from retrieved documents.</p>
                        </div>
                        <select id="system-langfuse-prompt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a Langfuse system prompt...</option>
                        </select>
                        <div id="system-prompt-preview" class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hidden">
                            <div class="text-xs text-gray-500 mb-2">Preview:</div>
                            <div class="text-sm font-mono text-gray-700 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>

                    <!-- Query Rephrasing Prompt Assignment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sync-alt text-green-600 mr-1"></i>Query Rephrasing Prompt
                        </label>
                        <div class="mb-2 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <p class="text-sm text-green-800"><strong>Role:</strong> Enhances user questions for better document retrieval</p>
                            <p class="text-xs text-green-600 mt-1">Reformulates questions using <code>{chat_history}</code> and <code>{question}</code> to improve RAG matching.</p>
                        </div>
                        <select id="processing-langfuse-prompt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="">Select a Langfuse query rephrasing prompt...</option>
                        </select>
                        <div id="processing-prompt-preview" class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hidden">
                            <div class="text-xs text-gray-500 mb-2">Preview:</div>
                            <div class="text-sm font-mono text-gray-700 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>

                    <!-- Context Template Prompt Assignment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-file-alt text-orange-600 mr-1"></i>Context Template Prompt
                        </label>
                        <div class="mb-2 p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                            <p class="text-sm text-orange-800"><strong>Role:</strong> Structures how context and questions are presented to the AI</p>
                            <p class="text-xs text-orange-600 mt-1">Formats retrieved documents with <code>{context}</code> and <code>{question}</code> for final AI processing.</p>
                        </div>
                        <select id="formatting-langfuse-prompt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select a Langfuse context template prompt...</option>
                        </select>
                        <div id="formatting-prompt-preview" class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hidden">
                            <div class="text-xs text-gray-500 mb-2">Preview:</div>
                            <div class="text-sm font-mono text-gray-700 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Local Mode Configuration -->
                <div id="local-config" class="space-y-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Local Prompt Configuration</h4>
                    
                    <!-- System Prompt Editor -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-robot text-blue-600 mr-1"></i>System Prompt
                        </label>
                        <div class="mb-2 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <p class="text-sm text-blue-800"><strong>Role:</strong> Sets the AI's core identity, behavior, and capabilities</p>
                            <p class="text-xs text-blue-600 mt-1">This is the foundational prompt that defines who the AI is and how it should behave across all interactions.</p>
                        </div>
                        <textarea 
                            id="local-system-prompt" 
                            rows="6" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                            placeholder="Tu esi naudingas Vilniaus miesto savivaldybės gyventojų aptarnavimo pokalbių robotas. Pasitelkdamas tau pateiktą informaciją, kurią turi kontekste, atsakyk piliečiui į jo klausimą jo klausimo kalba.

SVARBU: Jei tai ne pirmoji žinutė pokalbyje, atsižvelk į ankstesnį kontekstą ir negrįžk prie pasisveikinimo.

Jei klausimas neaiškus, užduok follow-up klausimą prieš atsakant. Niekada neišgalvok atsakymų, pasitelk tik informaciją, kurią turi. Gali cituoti tik nuorodas (URL) kurias turi kontekste.

Kontekstas:
------------
{context}
------------"
                        ></textarea>
                        <div class="mt-2 text-xs text-gray-500">
                            <strong>Variables:</strong> <code>{context}</code> • <strong>Required:</strong> Context variable must be included
                        </div>
                    </div>

                    <!-- Query Rephrasing Prompt Editor -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sync-alt text-green-600 mr-1"></i>Query Rephrasing Prompt
                        </label>
                        <div class="mb-2 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <p class="text-sm text-green-800"><strong>Role:</strong> Enhances user questions for better document retrieval</p>
                            <p class="text-xs text-green-600 mt-1">This prompt reformulates user questions using conversation history to improve RAG document matching before retrieval.</p>
                        </div>
                        <textarea 
                            id="local-processing-prompt" 
                            rows="4" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 font-mono text-sm"
                            placeholder="Šis pokalbis yra tarp piliečio ir Vilniaus miesto savivaldybės gyventojų aptarnavimo skyriaus. Atsižvelgdamas į visą pokalbį ir paskutinį klausimą, perfrazuok viską į vieną follow-up klausimą. Išskyrus jei klausimas nesusijęs su buvusiu kontekstu - tada tiesiog perrašyk naudotojo klausimą.

Poklabio istorija:
{chat_history}

Paskutinis klausimas: {question}

Tavo suformuluotas klausimas:"
                        ></textarea>
                        <div class="mt-2 text-xs text-gray-500">
                            <strong>Variables:</strong> <code>{chat_history}</code>, <code>{question}</code> • <strong>Required:</strong> Both variables must be included
                        </div>
                    </div>

                    <!-- Context Template Prompt Editor -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-file-alt text-orange-600 mr-1"></i>Context Template Prompt
                        </label>
                        <div class="mb-2 p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                            <p class="text-sm text-orange-800"><strong>Role:</strong> Structures how context and questions are presented to the AI</p>
                            <p class="text-xs text-orange-600 mt-1">This template formats the retrieved documents and user question before sending to the main AI system prompt for response generation.</p>
                        </div>
                        <textarea 
                            id="local-formatting-prompt" 
                            rows="4" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                            placeholder="TURIMI DUOMENYS:
{context}

KLAUSIMAS: {question}"
                        ></textarea>
                        <div class="mt-2 text-xs text-gray-500">
                            <strong>Variables:</strong> <code>{context}</code>, <code>{question}</code> • <strong>Required:</strong> Both variables must be included
                        </div>
                    </div>
                </div>

                <!-- Save Configuration Button -->
                <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                    <div id="prompt-save-status" class="text-sm text-gray-500"></div>
                    <div class="flex items-center gap-3">
                        <button id="save-prompt-config" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                            <i class="fas fa-save"></i>
                            Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Management Tab -->
        <div id="knowledge-tab" class="tab-content hidden">
            <!-- AI Provider Configuration Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-brain text-indigo-600"></i>
                    AI Provider Configuration
                </h2>
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                            <strong>Configure AI Provider:</strong> Select and configure the AI provider with separate models for main responses and lightweight query rephrasing.
                        </div>
                    </div>
                </div>

                <form id="ai-provider-form" class="space-y-6">
                    <!-- Provider Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">AI Provider</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="ai_provider" value="flowise" id="provider-flowise" class="text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-900">Flowise</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="ai_provider" value="openrouter" id="provider-openrouter" class="text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-900">OpenRouter</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Flowise Configuration -->
                    <div id="flowise-config" class="space-y-4 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-medium text-gray-900">Flowise Configuration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="flowise-url" class="block text-sm font-medium text-gray-700 mb-1">Flowise URL</label>
                                <input type="url" id="flowise-url" name="flowise_url"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="https://your-flowise-url.com">
                            </div>
                            <div>
                                <label for="flowise-chatflow-id" class="block text-sm font-medium text-gray-700 mb-1">Chatflow ID</label>
                                <input type="text" id="flowise-chatflow-id" name="flowise_chatflow_id"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="Enter Flowise Chatflow ID">
                            </div>
                        </div>
                        <button type="button" id="test-flowise" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-flask mr-2"></i>Test Connection
                        </button>
                    </div>

                    <!-- OpenRouter Configuration -->
                    <div id="openrouter-config" class="space-y-4 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-medium text-gray-900">OpenRouter Configuration</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label for="openrouter-api-key" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <input type="password" id="openrouter-api-key" name="openrouter_api_key"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="Enter OpenRouter API key">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="openrouter-model" class="block text-sm font-medium text-gray-700 mb-1">Main AI Model</label>
                                    <select id="openrouter-model" name="openrouter_model"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        <option value="anthropic/claude-sonnet-4">Claude Sonnet 4</option>
                                        <option value="openai/gpt-5-chat">GPT-5 Chat</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Used for main AI responses and complex reasoning</p>
                                </div>
                                <div>
                                    <label for="rephrasing-model" class="block text-sm font-medium text-gray-700 mb-1">Rephrasing Model</label>
                                    <select id="rephrasing-model" name="rephrasing_model"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="google/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                                        <option value="openai/gpt-5-nano">GPT-5 Nano</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Lightweight model for query rephrasing and quick tasks</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="site-url" class="block text-sm font-medium text-gray-700 mb-1">Site URL</label>
                                    <input type="url" id="site-url" name="site_url"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="https://your-site.com">
                                </div>
                                <div>
                                    <label for="site-name" class="block text-sm font-medium text-gray-700 mb-1">Site Name</label>
                                    <input type="text" id="site-name" name="site_name"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="Your Site Name">
                                </div>
                            </div>
                        </div>
                        <button type="button" id="test-openrouter" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-flask mr-2"></i>Test Connection
                        </button>
                    </div>

                    <!-- Save Buttons -->
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" id="reset-provider-form" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button type="submit" id="save-provider-config" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Configuration
                        </button>
                    </div>
                </form>
            </div>

            <!-- Vector Database Management -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-database text-purple-600"></i>
                    Vector Database Management
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">ChromaDB Status</p>
                                <p id="chromadb-status" class="text-lg font-semibold text-green-600">Connected</p>
                            </div>
                            <i class="fas fa-database text-2xl text-purple-600"></i>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Documents</p>
                                <p id="total-documents" class="text-lg font-semibold text-blue-600">0</p>
                            </div>
                            <i class="fas fa-file-alt text-2xl text-blue-600"></i>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Embeddings</p>
                                <p id="total-embeddings" class="text-lg font-semibold text-indigo-600">0</p>
                            </div>
                            <i class="fas fa-vector-square text-2xl text-indigo-600"></i>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button id="refresh-vector-stats" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Stats
                    </button>
                    <button id="clear-vector-db" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Clear Database
                    </button>
                </div>
            </div>

            <!-- Document Upload Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-green-600"></i>
                    Document Upload
                </h2>

                <!-- File Upload Area -->
                <div id="file-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-green-500 hover:bg-green-50 transition-all cursor-pointer mb-4">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-cloud-upload-alt text-6xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Drop files here or click to upload</h3>
                    <p class="text-sm text-gray-500 mb-4">Supported formats: .txt, .docx, .pdf (max 50MB)</p>
                    <button type="button" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Select Files
                    </button>
                    <input type="file" id="file-input" accept=".txt,.docx,.pdf" multiple style="display: none;">
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                            <span class="text-blue-700">Uploading and processing documents...</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Management Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-folder-open text-blue-600"></i>
                        Uploaded Documents
                    </h2>
                    <div class="flex items-center gap-2">
                        <button id="refresh-documents" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="clear-all-documents" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">
                            <i class="fas fa-trash-alt mr-2"></i>Clear All
                        </button>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-medium text-blue-900 mb-1">
                        <i class="fas fa-info-circle mr-2"></i>Document Management
                    </h3>
                    <p class="text-sm text-blue-700">Documents uploaded through the interface are processed and indexed for semantic search.</p>
                </div>

                <!-- Documents List Container -->
                <div id="documents-list" class="space-y-2">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p>No documents uploaded yet</p>
                    </div>
                </div>
            </div>

            <!-- API Integration & Documentation Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-code text-purple-600"></i>
                    API Integration & Documentation
                </h2>

                <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-purple-600 mt-0.5"></i>
                        <div class="text-sm text-purple-800">
                            <p class="font-medium mb-2">Programmatic Knowledge Base Access</p>
                            <p>Use these API endpoints to integrate the knowledge base with external systems, automation scripts, or bulk upload workflows. All endpoints support authentication via JWT tokens.</p>
                        </div>
                    </div>
                </div>

                <!-- API Sections Container -->
                <div class="space-y-6">
                    <!-- File Upload API Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex items-center justify-between rounded-t-lg transition-colors"
                                data-toggle="api-upload-section" type="button">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-upload text-green-600"></i>
                                <span class="font-medium text-gray-900">File Upload API</span>
                                <span class="text-sm text-gray-500">POST /api/knowledge/documents/upload</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform" id="api-upload-chevron"></i>
                        </button>
                        <div id="api-upload-section" class="p-4 border-t border-gray-200 hidden">
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600">Upload documents (.txt, .docx) with automatic processing and indexing.</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Details</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><strong>Method:</strong> POST</li>
                                            <li><strong>Content-Type:</strong> multipart/form-data</li>
                                            <li><strong>File Field:</strong> file</li>
                                            <li><strong>Max Size:</strong> 50MB</li>
                                            <li><strong>Formats:</strong> .txt, .docx</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Authentication</h4>
                                        <p class="text-sm text-gray-600">Include JWT token in Authorization header</p>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-gray-900">cURL Example</h4>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="upload-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="upload-curl-code"><code>curl -X POST <span id="api-base-url-upload">http://localhost:3002</span>/api/knowledge/documents/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/your/document.txt" \
  -F "source=api"</code></pre>
                                </div>

                                <div>
                                    <h4 class="font-medium text-gray-900 mb-2">Response Format</h4>
                                    <pre class="bg-gray-50 border border-gray-200 p-3 rounded text-sm overflow-x-auto"><code>{
  "success": true,
  "message": "File uploaded and processed successfully",
  "data": {
    "documentId": "uuid-here",
    "originalName": "document.txt",
    "size": 1024,
    "status": "indexed",
    "chunksCount": 3
  }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Single Document API Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex items-center justify-between rounded-t-lg transition-colors"
                                data-toggle="api-single-section" type="button">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-file-alt text-blue-600"></i>
                                <span class="font-medium text-gray-900">Single Document API</span>
                                <span class="text-sm text-gray-500">POST /api/knowledge/documents/index</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform" id="api-single-chevron"></i>
                        </button>
                        <div id="api-single-section" class="p-4 border-t border-gray-200 hidden">
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600">Index a single document directly with JSON data - no file upload required.</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Request Fields</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><strong>body:</strong> Document content (required)</li>
                                            <li><strong>title:</strong> Document title (optional)</li>
                                            <li><strong>sourceUrl:</strong> Source URL (optional)</li>
                                            <li><strong>date:</strong> ISO date (optional)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Details</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><strong>Method:</strong> POST</li>
                                            <li><strong>Content-Type:</strong> application/json</li>
                                            <li><strong>Auth:</strong> JWT required</li>
                                        </ul>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-gray-900">cURL Example</h4>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="single-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="single-curl-code"><code>curl -X POST <span id="api-base-url-single">http://localhost:3002</span>/api/knowledge/documents/index \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "body": "Your document content here...",
    "title": "Document Title",
    "sourceUrl": "https://example.com/source",
    "date": "2024-12-26T10:30:00Z"
  }'</code></pre>
                                </div>

                                <div>
                                    <h4 class="font-medium text-gray-900 mb-2">Response Format</h4>
                                    <pre class="bg-gray-50 border border-gray-200 p-3 rounded text-sm overflow-x-auto"><code>{
  "success": true,
  "message": "Document indexed successfully",
  "data": {
    "documentId": "uuid-here",
    "title": "Document Title",
    "chunksCount": 1,
    "totalLength": 242,
    "status": "indexed"
  }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Upload API Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex items-center justify-between rounded-t-lg transition-colors"
                                data-toggle="api-batch-section" type="button">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-layer-group text-orange-600"></i>
                                <span class="font-medium text-gray-900">Batch Upload API</span>
                                <span class="text-sm text-gray-500">POST /api/knowledge/documents/index-batch</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform" id="api-batch-chevron"></i>
                        </button>
                        <div id="api-batch-section" class="p-4 border-t border-gray-200 hidden">
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600">Upload multiple documents in a single request - ideal for bulk operations and automated workflows.</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Request Format</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><strong>documents:</strong> Array of document objects</li>
                                            <li><strong>Limit:</strong> Max 10,000 documents</li>
                                            <li><strong>Fields:</strong> Same as single document</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900 mb-2">Details</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><strong>Method:</strong> POST</li>
                                            <li><strong>Content-Type:</strong> application/json</li>
                                            <li><strong>Auth:</strong> JWT required</li>
                                        </ul>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-medium text-gray-900">cURL Example</h4>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="batch-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="batch-curl-code"><code>curl -X POST <span id="api-base-url-batch">http://localhost:3002</span>/api/knowledge/documents/index-batch \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "documents": [
      {
        "body": "First document content...",
        "title": "Document 1"
      },
      {
        "body": "Second document content...",
        "title": "Document 2",
        "sourceUrl": "https://example.com/doc2"
      }
    ]
  }'</code></pre>
                                </div>

                                <div>
                                    <h4 class="font-medium text-gray-900 mb-2">Response Format</h4>
                                    <pre class="bg-gray-50 border border-gray-200 p-3 rounded text-sm overflow-x-auto"><code>{
  "success": true,
  "message": "Batch indexing completed: 2 successful, 0 failed",
  "data": {
    "successful": [
      {
        "index": 0,
        "documentId": "uuid-1",
        "title": "Document 1",
        "status": "indexed"
      },
      {
        "index": 1,
        "documentId": "uuid-2",
        "title": "Document 2",
        "status": "indexed"
      }
    ],
    "failed": [],
    "summary": {
      "total": 2,
      "successful": 2,
      "failed": 0
    }
  }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Retrieval API Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex items-center justify-between rounded-t-lg transition-colors"
                                data-toggle="api-retrieval-section" type="button">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-search text-indigo-600"></i>
                                <span class="font-medium text-gray-900">Document Retrieval APIs</span>
                                <span class="text-sm text-gray-500">GET endpoints</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform" id="api-retrieval-chevron"></i>
                        </button>
                        <div id="api-retrieval-section" class="p-4 border-t border-gray-200 hidden">
                            <div class="space-y-6">
                                <p class="text-sm text-gray-600">Retrieve documents, statistics, and search the knowledge base programmatically.</p>

                                <!-- List All Documents -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-medium text-gray-900">List All Documents</h4>
                                            <p class="text-sm text-gray-600">GET /api/knowledge/documents</p>
                                        </div>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="list-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="list-curl-code"><code>curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  <span id="api-base-url-list">http://localhost:3002</span>/api/knowledge/documents</code></pre>
                                </div>

                                <!-- Get Statistics -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-medium text-gray-900">Get Statistics</h4>
                                            <p class="text-sm text-gray-600">GET /api/knowledge/stats</p>
                                        </div>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="stats-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="stats-curl-code"><code>curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  <span id="api-base-url-stats">http://localhost:3002</span>/api/knowledge/stats</code></pre>
                                </div>

                                <!-- Search Documents -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-medium text-gray-900">Search Documents</h4>
                                            <p class="text-sm text-gray-600">GET /api/knowledge/documents/search?query=text</p>
                                        </div>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="search-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="search-curl-code"><code>curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  "<span id="api-base-url-search">http://localhost:3002</span>/api/knowledge/documents/search?query=tourism"</code></pre>
                                </div>

                                <!-- Get Indexed Documents -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-medium text-gray-900">Get Indexed Documents</h4>
                                            <p class="text-sm text-gray-600">GET /api/knowledge/indexed?limit=N</p>
                                        </div>
                                        <button class="copy-code-btn bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200"
                                                data-copy="indexed-curl">
                                            <i class="fas fa-copy mr-1"></i>Copy
                                        </button>
                                    </div>
                                    <pre class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto" id="indexed-curl-code"><code>curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  "<span id="api-base-url-indexed">http://localhost:3002</span>/api/knowledge/indexed?limit=100"</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Authentication Help Section -->
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="font-medium text-yellow-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-key"></i>
                        Authentication & JWT Tokens
                    </h4>
                    <div class="text-sm text-yellow-800 space-y-2">
                        <p>All API endpoints require authentication. Replace <code class="bg-yellow-200 px-1 rounded">YOUR_JWT_TOKEN</code> with your actual JWT token.</p>
                        <p><strong>Getting a token:</strong> Login via <code class="bg-yellow-200 px-1 rounded">POST /api/auth/login</code> to receive a JWT token in the response.</p>
                        <p><strong>Current session:</strong> <span id="current-session-status" class="font-medium">Checking...</span></p>
                    </div>
                </div>
            </div>

            <!-- Vector Search & Indexed Documents Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-database text-purple-600"></i>
                        Vector Database Contents
                    </h2>
                    <button id="refresh-indexed" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>

                <!-- Vector Search Interface -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                    <h3 class="font-medium text-purple-900 mb-1">
                        <i class="fas fa-search mr-2"></i>Search Vector Database
                    </h3>
                    <p class="text-sm text-purple-700 mb-3">Search through document chunks indexed in the vector database.</p>

                    <div class="flex gap-3">
                        <input
                            type="text"
                            id="vector-search-input"
                            placeholder="Search through indexed documents..."
                            class="flex-1 px-3 py-2 border border-purple-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                        >
                        <button
                            id="vector-search-button"
                            class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm"
                        >
                            <i class="fas fa-search mr-1"></i>Search
                        </button>
                        <button
                            id="clear-vector-search"
                            class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm hidden"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Search Results Container -->
                <div id="vector-search-results" class="space-y-2 mb-4 hidden">
                    <!-- Search results will be shown here -->
                </div>

                <!-- Indexed Documents List Container -->
                <div id="indexed-list" class="space-y-2">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-database text-4xl mb-2"></i>
                        <p>Loading vector database contents...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Tab -->
        <div id="categories-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-tags text-indigo-600"></i>
                        Category Management
                    </h2>
                    <button id="create-category-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Create Category
                    </button>
                </div>

                <p class="text-gray-600 mb-6">Manage ticket categories to help organize and track conversations. Only administrators can create and manage categories.</p>

                <!-- Category Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <label for="category-search" class="text-sm font-medium text-gray-700">Search:</label>
                        <input type="text" id="category-search" placeholder="Search categories..." class="border border-gray-300 rounded-md px-3 py-1 text-sm w-48">
                    </div>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="include-archived-categories" class="rounded">
                        Show archived categories
                    </label>
                </div>

                <!-- Categories List -->
                <div id="categories-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-tags text-3xl mb-2"></i>
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>

            <!-- Category Statistics (Admin Only) -->
            <div id="category-stats-section" class="bg-white rounded-lg shadow-md p-6 admin-only">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-indigo-600"></i>
                    Category Statistics
                </h3>
                <div id="category-stats-content">
                    <p class="text-gray-500">Loading statistics...</p>
                </div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="users-tab" class="tab-content hidden">
            <!-- Security Policy Section (Admin Only) -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 admin-only">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-indigo-600"></i>
                    Security Policy
                </h2>

                <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-amber-600 mt-0.5"></i>
                        <div class="text-sm text-amber-800">
                            <p class="font-medium mb-1">Organization-Wide Security Setting</p>
                            <p>When enabled, all users will be required to set up two-factor authentication on their next login. This policy applies to all user accounts.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">Require 2FA for All Users</h3>
                            <p class="text-sm text-gray-600 mt-1">Enforce two-factor authentication for all user accounts</p>
                            <p class="text-xs text-gray-500 mt-2" id="users-without-2fa-count">Loading user statistics...</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                            <input type="checkbox" id="require-2fa-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                </div>

                <div class="mt-4 text-sm text-gray-500">
                    <p><strong>Note:</strong> Users without 2FA will be redirected to set it up on their next login attempt.</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-users-cog text-indigo-600"></i>
                        User Management
                    </h2>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-500">
                            Total Users: <span id="total-users" class="font-medium">Loading...</span>
                        </div>
                        <button id="add-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add New User
                        </button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Response Templates Tab -->
        <div id="templates-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-file-alt text-indigo-600"></i>
                        Response Templates
                    </h2>
                    <button id="create-template-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Create Template
                    </button>
                </div>

                <p class="text-gray-600 mb-6">Manage response templates to help agents provide quick and consistent answers. Only administrators can create and manage templates.</p>

                <!-- Template Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <label for="template-search" class="text-sm font-medium text-gray-700">Search:</label>
                        <input type="text" id="template-search" placeholder="Search templates..." class="border border-gray-300 rounded-md px-3 py-1 text-sm w-48">
                    </div>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="include-inactive-templates" class="rounded">
                        Show inactive templates
                    </label>
                </div>

                <!-- Templates List -->
                <div id="templates-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-file-alt text-3xl mb-2"></i>
                        <p>Loading templates...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branding Configuration Tab -->
        <div id="branding-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-palette text-indigo-600"></i>
                        Branding & Customization
                    </h2>
                    <div class="flex items-center gap-3">
                        <button id="branding-reset-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i class="fas fa-undo"></i>
                            Reset to Defaults
                        </button>
                    </div>
                </div>
                
                <form id="branding-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Widget Appearance -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">Widget Appearance</h3>
                            
                            <div>
                                <label for="widget-name" class="block text-sm font-medium text-gray-700 mb-2">Widget Name</label>
                                <input type="text" id="widget-name" name="widget_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Vilnius Assistant">
                                <p class="text-xs text-gray-500 mt-1">Display name shown in the chat widget header</p>
                            </div>
                            
                            <div>
                                <label for="widget-primary-color" class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="widget-primary-color" name="widget_primary_color" class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#2c5530">
                                    <input type="text" id="widget-primary-color-text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="#2c5530">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Main color for buttons, headers, and accents</p>
                            </div>
                            
                            <div>
                                <label for="user-message-color" class="block text-sm font-medium text-gray-700 mb-2">User Message Color</label>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="user-message-color" name="user_message_color" class="w-16 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#3b82f6">
                                    <input type="text" id="user-message-color-text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="#3b82f6">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Color for user message bubbles</p>
                            </div>
                            
                            <div>
                                <label for="widget-allowed-domains" class="block text-sm font-medium text-gray-700 mb-2">Allowed Domains</label>
                                <input type="text" id="widget-allowed-domains" name="widget_allowed_domains" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="*">
                                <p class="text-xs text-gray-500 mt-1">Domains where widget can be embedded (* for all)</p>
                            </div>
                        </div>
                        
                        <!-- Site Configuration -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">Site Configuration</h3>
                            
                            
                            <div>
                                <label for="welcome-message" class="block text-sm font-medium text-gray-700 mb-2">Welcome Message</label>
                                <textarea id="welcome-message" name="welcome_message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Hello! How can I help you today?"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Initial message shown when users open the chat</p>
                            </div>

                            <div>
                                <label for="privacy-checkbox-text" class="block text-sm font-medium text-gray-700 mb-2">Privacy Policy Checkbox Text</label>
                                <textarea id="privacy-checkbox-text" name="privacy_checkbox_text" rows="3" maxlength="500" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="I agree to the [Privacy Policy](https://example.com/privacy) and [Terms of Service](https://example.com/terms)."></textarea>
                                <p class="text-xs text-gray-500 mt-1">Text shown with privacy checkbox. Supports Markdown for links (e.g., [Privacy Policy](https://...)). Max 500 characters.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Live Preview -->
                    <div class="mt-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4 border-b border-gray-200 pb-2">Live Preview</h3>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <div id="widget-preview" class="max-w-sm mx-auto">
                                <!-- Widget preview will be rendered here -->
                                <div class="bg-white border border-gray-300 rounded-lg shadow-lg overflow-hidden">
                                    <div id="preview-header" class="px-4 py-3 text-white font-medium" style="background-color: #2c5530;">
                                        <span id="preview-widget-name">Vilnius Assistant</span>
                                    </div>
                                    <div class="p-4 space-y-3">
                                        <div class="bg-gray-100 rounded-lg p-3">
                                            <span id="preview-welcome-message" class="text-sm text-gray-700">Hello! How can I help you today?</span>
                                        </div>
                                        <div class="flex justify-end">
                                            <div id="preview-user-message" class="text-white rounded-lg px-3 py-2 text-sm max-w-xs" style="background-color: #3b82f6;">
                                                This is a sample user message
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-t border-gray-200 px-4 py-3 bg-gray-50">
                                        <div class="flex items-center gap-2">
                                            <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Type your message..." disabled>
                                            <button class="px-4 py-2 rounded-lg text-sm text-white font-medium" style="background-color: #2c5530;" disabled>
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                        <button type="button" id="branding-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="branding-save-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                            Save Changes
                        </button>
                    </div>
                </form>
                
                <!-- Integration Code Section -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-800 mb-4">
                        <i class="fas fa-code text-indigo-600 mr-2"></i>
                        Widget Integration Code
                    </h4>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <h5 class="font-semibold text-green-800 mb-2">Embed Widget on Your Website</h5>
                        <p class="text-green-700">Copy and paste this code into your website's HTML to add the chat widget with your current branding.</p>
                    </div>
                    
                    <button id="generate-integration-code" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors mb-4">
                        <i class="fas fa-magic mr-2"></i>Generate Integration Code
                    </button>
                    
                    <div id="integration-code-container" class="hidden">
                        <div class="mb-4">
                            <label for="integration-code" class="block text-sm font-medium text-gray-700 mb-2">HTML Integration Code</label>
                            <textarea id="integration-code" readonly rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"></textarea>
                        </div>
                        <button id="copy-integration-code" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                        </button>
                        
                        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="font-semibold text-blue-800 mb-2">Integration Instructions:</h5>
                            <ol class="list-decimal list-inside text-blue-700 space-y-1">
                                <li>Copy the integration code above</li>
                                <li>Paste it into your website's HTML, preferably before the closing &lt;/body&gt; tag</li>
                                <li>The widget will appear as a floating chat button in the bottom-right corner</li>
                                <li>Users can click it to start chatting with the assistant</li>
                                <li>The widget will use your current branding settings automatically</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics-tab" class="tab-content hidden">
            <div id="statistics-section"></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit User</h3>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                
                <div class="mb-4">
                    <label for="edit-first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" id="edit-first-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="mb-4">
                    <label for="edit-last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="edit-last-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="mb-4">
                    <label for="edit-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="edit-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="mb-6">
                    <label for="edit-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="edit-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="agent">Agent</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Save Changes
                    </button>
                    <button type="button" id="cancel-edit" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Password Modal -->
    <div id="new-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">New Password Generated</h3>
                <button id="close-password-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">A new password has been generated for the user. This is the only time it will be displayed.</p>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <span id="generated-password" class="font-mono text-lg"></span>
                        <button id="copy-password" class="ml-2 text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Make sure to copy this password and share it securely with the user. You won't be able to see it again.
                </p>
            </div>
            
            <button id="password-modal-close" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                I've Copied the Password
            </button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add New User</h3>
                <button id="close-add-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="add-user-form">
                <div class="mb-4">
                    <label for="add-first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" id="add-first-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="add-last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="add-last-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="add-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="add-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="add-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="add-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="agent">Agent</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button type="button" id="cancel-add-user" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Create User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOTP Setup Modal -->
    <div id="totp-setup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Enable Two-Factor Authentication</h3>
                <button id="close-totp-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-4">Setting up 2FA for: <strong id="totp-setup-username"></strong></p>

                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Step 1: Scan QR Code</h4>
                    <p class="text-xs text-gray-600 mb-3">Scan this QR code with Google Authenticator, Authy, or any TOTP authenticator app:</p>
                    <div class="flex justify-center mb-3">
                        <img id="totp-qr-code" class="border border-gray-300 rounded" alt="QR Code" />
                    </div>
                    <p class="text-xs text-gray-600 mb-1">Or enter this secret manually:</p>
                    <code id="totp-secret-text" class="block text-center p-2 bg-white rounded border border-gray-200 text-sm font-mono"></code>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Step 2: Verify Code</h4>
                    <p class="text-xs text-gray-600 mb-3">Enter the 6-digit code from your authenticator app:</p>
                    <input type="text" id="totp-verify-code" maxlength="6" placeholder="000000"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-center text-lg font-mono tracking-widest">
                </div>
            </div>

            <div class="flex gap-3">
                <button type="button" id="cancel-totp-setup" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="button" id="verify-totp-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-shield-alt mr-2"></i>Verify & Enable
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Codes Modal -->
    <div id="backup-codes-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-key text-yellow-600 mr-2"></i>Backup Recovery Codes
                </h3>
                <button id="close-backup-codes-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800 font-semibold mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Save These Codes Safely!
                    </p>
                    <p class="text-xs text-yellow-700">
                        Store these backup codes in a secure location. Each code can be used once if you lose access to your authenticator app.
                    </p>
                </div>

                <p class="text-sm text-gray-600 mb-3">Backup codes for: <strong id="backup-codes-username"></strong></p>

                <div id="backup-codes-list" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                </div>

                <button onclick="navigator.clipboard.writeText(Array.from(document.getElementById('backup-codes-list').children).map(c => c.textContent).join('\\n')); alert('Codes copied to clipboard!')"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition-colors text-sm">
                    <i class="fas fa-copy mr-2"></i>Copy All Codes
                </button>
            </div>

            <button type="button" id="close-backup-codes" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                Done
            </button>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message" class="hidden fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-40 max-w-sm">
        <div class="flex items-center gap-2">
            <i id="message-icon" class="fas"></i>
            <span id="message-text"></span>
        </div>
    </div>

    <!-- Socket.IO for real-time updates -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Phase 1: Modern ES6 Modular Settings System -->
    
    <!-- Load Settings JavaScript - New Modular Architecture -->
    <!-- Migrated from monolithic settings.js to modular ES6 system -->
    <!-- Integrated with agent-dashboard utilities (Toast, ErrorHandler) -->
    
    <script type="module" src="js/settings/SettingsManager.js"></script>

    <!-- Hash routing for direct tab access -->
    <script>
        // Handle hash routing for direct tab access (e.g., settings.html#knowledge)
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                // Wait for the settings manager to initialize, then activate the tab
                setTimeout(() => {
                    const targetTab = document.querySelector(`button[data-tab="${hash}"]`);
                    if (targetTab) {
                        targetTab.click();
                    }
                }, 100);
            }
        });
    </script>
    
    <!-- Legacy settings.js preserved as backup during migration -->
    <!-- <script src="js/settings.js"></script> -->

    <!-- Prompt View Modal -->
    <div id="prompt-view-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="prompt-view-title">Prompt Details</h3>
                <button id="close-prompt-view-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Prompt Metadata -->
                <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Name:</label>
                        <p id="prompt-view-name" class="text-gray-900 font-mono text-sm"></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Source:</label>
                        <p id="prompt-view-source" class="text-gray-900 text-sm"></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Version:</label>
                        <p id="prompt-view-version" class="text-gray-900 text-sm"></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">From Langfuse:</label>
                        <p id="prompt-view-langfuse" class="text-gray-900 text-sm"></p>
                    </div>
                </div>

                <!-- Prompt Content -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Prompt Content:</label>
                    <div class="relative">
                        <pre id="prompt-view-content" class="bg-gray-100 p-4 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
                        <button 
                            id="copy-prompt-content" 
                            class="absolute top-2 right-2 bg-white hover:bg-gray-50 border border-gray-300 px-2 py-1 rounded text-xs"
                        >
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>

                <!-- Template Variables Preview -->
                <div class="border-t pt-4">
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Template Variables Found:</label>
                    <div id="prompt-variables-list" class="flex flex-wrap gap-2">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between pt-4 border-t">
                    <button 
                        id="test-prompt-btn" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                    >
                        <i class="fas fa-play"></i> Test Prompt
                    </button>
                    <div class="flex gap-2">
                        <button 
                            id="edit-prompt-btn" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                        >
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button 
                            id="close-prompt-view" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Edit Modal -->
    <div id="prompt-edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="prompt-edit-title">Edit Prompt</h3>
                <button id="close-prompt-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="prompt-edit-form" class="space-y-6">
                <!-- Prompt Name -->
                <div>
                    <label for="prompt-edit-name" class="block text-sm font-medium text-gray-700 mb-2">
                        Prompt Name
                    </label>
                    <input 
                        type="text" 
                        id="prompt-edit-name" 
                        readonly
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                    >
                </div>

                <!-- Template Variables Help -->
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-medium mb-2">Template Variables</p>
                            <div class="space-y-1 text-xs bg-blue-100 p-2 rounded font-mono">
                                <div><strong>{{context}}</strong> - Retrieved documents from knowledge base</div>
                                <div><strong>{{question}}</strong> - Current user question</div>
                                <div><strong>{{formatted_history}}</strong> - Previous conversation history</div>
                            </div>
                            <p class="mt-2 text-xs">Use double curly braces for variables in Langfuse prompts.</p>
                        </div>
                    </div>
                </div>

                <!-- Prompt Content Editor -->
                <div>
                    <label for="prompt-edit-content" class="block text-sm font-medium text-gray-700 mb-2">
                        Prompt Content
                    </label>
                    <textarea 
                        id="prompt-edit-content"
                        rows="12"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-vertical font-mono text-sm"
                        placeholder="Enter your prompt content with template variables like {{context}}, {{question}}, {{formatted_history}}..."
                    ></textarea>
                </div>

                <!-- Live Preview -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Live Preview (with sample data)
                    </label>
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 max-h-48 overflow-y-auto">
                        <pre id="prompt-edit-preview" class="text-sm whitespace-pre-wrap text-gray-700"></pre>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-2 pt-4 border-t">
                    <button 
                        type="button"
                        id="test-prompt-edit-btn" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                    >
                        <i class="fas fa-play"></i> Test
                    </button>
                    <button 
                        type="button"
                        id="cancel-prompt-edit" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        id="save-prompt-btn" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="prompt-test-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Prompt Test Results</h3>
                <button id="close-prompt-test-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Test Variables -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Test Variables:</label>
                    <div class="grid grid-cols-1 gap-3 p-4 bg-gray-50 rounded-lg text-sm">
                        <div>
                            <strong>Context:</strong> <span id="test-var-context" class="font-mono text-xs"></span>
                        </div>
                        <div>
                            <strong>Question:</strong> <span id="test-var-question" class="font-mono text-xs"></span>
                        </div>
                        <div>
                            <strong>History:</strong> <span id="test-var-history" class="font-mono text-xs"></span>
                        </div>
                    </div>
                </div>

                <!-- Compiled Result -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Compiled Prompt:</label>
                    <div class="border border-gray-200 rounded-lg p-4 bg-white max-h-96 overflow-y-auto">
                        <pre id="test-compiled-content" class="text-sm whitespace-pre-wrap"></pre>
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button 
                        id="close-test-results" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 id="category-modal-title" class="text-lg font-semibold text-gray-900">Create Category</h3>
                <button id="close-category-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="category-form">
                <div class="mb-4">
                    <label for="category-name" class="block text-sm font-medium text-gray-700 mb-2">
                        Category Name *
                    </label>
                    <input type="text" id="category-name" name="name" required maxlength="100"
                           placeholder="Enter category name"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Maximum 100 characters</p>
                </div>

                <div class="mb-4">
                    <label for="category-description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea id="category-description" name="description" rows="3" maxlength="500"
                              placeholder="Optional description of this category"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Maximum 500 characters</p>
                </div>

                <div class="mb-4">
                    <label for="category-color" class="block text-sm font-medium text-gray-700 mb-2">
                        Color
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="category-color" name="color" value="#6B7280"
                               class="w-12 h-8 border border-gray-300 rounded cursor-pointer">
                        <input type="text" id="category-color-hex" value="#6B7280" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$"
                               placeholder="#6B7280"
                               class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Used to visually distinguish categories</p>
                </div>


                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancel-category"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="save-category"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <span id="save-category-text">Create Category</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-2xl w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 id="template-modal-title" class="text-lg font-semibold text-gray-900">Create Template</h3>
                <button id="close-template-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="template-form">
                <div class="mb-4">
                    <label for="template-title" class="block text-sm font-medium text-gray-700 mb-2">
                        Template Title *
                    </label>
                    <input type="text" id="template-title" name="title" required maxlength="200"
                           placeholder="Enter template title"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Maximum 200 characters</p>
                </div>

                <div class="mb-4">
                    <label for="template-content" class="block text-sm font-medium text-gray-700 mb-2">
                        Template Content *
                    </label>
                    <textarea id="template-content" name="content" rows="6" required maxlength="10000"
                              placeholder="Enter template content"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Maximum 10,000 characters</p>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancel-template"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="save-template"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <span id="save-template-text">Create Template</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check if 2FA reminder should be shown
        function check2FAReminder() {
            const userData = localStorage.getItem('user_data');
            if (!userData) return;

            const user = JSON.parse(userData);
            const isAdminOrAgent = user.role === 'admin' || user.role === 'agent';
            const has2FA = user.totp_enabled;

            // Show reminder if admin/agent without 2FA
            if (isAdminOrAgent && !has2FA) {
                const reminderDismissed = localStorage.getItem('2fa_reminder_dismissed');
                const now = Date.now();

                // Show if never dismissed, or dismissed more than 7 days ago
                if (!reminderDismissed || (now - parseInt(reminderDismissed)) > 7 * 24 * 60 * 60 * 1000) {
                    const banner = document.getElementById('2fa-reminder-banner');
                    if (banner) {
                        banner.classList.remove('hidden');
                    }
                }
            }
        }

        function dismiss2FAReminder() {
            localStorage.setItem('2fa_reminder_dismissed', Date.now());
            const banner = document.getElementById('2fa-reminder-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }

        // Check on page load
        document.addEventListener('DOMContentLoaded', check2FAReminder);
    </script>

</body>
</html>