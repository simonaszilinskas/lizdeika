# Lizdeika: Simple Customer Support System

## What It Is
Lizdeika is a system that helps Vilnius city answer questions from citizens. It has two ways to work:
1. **Autopilot**: The computer answers all questions immediately by itself
2. **Assisted**: The computer suggests answers to human workers who then decide what to send back

Everything except the brain (AI part) runs on Vilnius city's own computers. The AI part lives on the internet and we just ask it questions.

## Main Parts

### 1. The Chat Window (Widget)
- **What it is**: A small chat box that can be put on any website
- **How it works**:
  - People type questions into this box
  - The system either answers immediately (Autopilot) or a human helps (Assisted)
  - Must work like embedding a YouTube video - just one line of code
  - Must be accessible
- **Requirements**:
  - Shows conversation history
  - Works on phones and computers
  - If a human is helping, shows "someone is working on your answer"
  - If a bot is helping, shows "the response is being generated by our robot Lizdeika - he is still learning and might provide wrong answers"
  - If no workers are available and autopilot isn't on, the users should get a message that their message will be answered when the workers will be back


### 2. Human Helper Dashboard (Agent Dashboard)
- **What it is**: A special website for city workers to help answer questions
- **How it works**:
  - Workers log in with username and password
  - Shows unanswered questions from citizens
  - For each question, shows:
    - The citizen's question
    - Computer's suggested answer
    - Three buttons: SEND AS IS, FIX IT, WRITE MY OWN
  - Workers click one button and send their response
- **Requirements**:
  - Must be easy to use - no complicated steps
  - Shows who said what in the conversation
  - Workers can see past conversations with the same person (optional)
  - There might be multiple workers at once - you need to assign tickets randomly to those that are logged in
  - Workers should be able to turn on autopilot but still see conversations with it and be able to write a message


### 3. Information Library (Document System)
- **What it is**: Where we store all the information the computer uses to answer questions
- **How it works**:
  - Workers can upload documents (only word documents and other simple to read formats - no PDFs for now) through the dashboard
  - The system chunks and sends the new documents for embeddings as they come in
  - When a question comes in, the system finds the most relevant documents (k=150)
  - Also gets information from "Siurblys" - an API that allows to add chunks of text (explained below)
- **Requirements**:
  - Can search through all uploaded information quickly
  - Shows list of uploaded documents and when they were added

### 4. Document Ingestion API
- **What it is**: An API endpoint that accepts documents from external sources
- **How it works**:
  - External systems (like Siurblys) send documents via HTTP POST with API key
  - System processes documents, creates embeddings, and stores in Information Library
  - Replaces old versions of documents if they exist
- **Requirements**:
  - Must authenticate requests with API key
  - Should handle text content in JSON format
  - Must chunk documents by character count without breaking sentences
  - Should generate embeddings using Mistral-embed 

### 5. Cleanup Crew (Data Cleaning)
- **What it is**: A background worker that keeps the system tidy
- **How it works**:
  - Runs automatically every week
  - Does two main jobs:
    1. Removes old conversation records (keeps only the last half of year)
    2. Checks if information in the library is outdated and removes it
- **Requirements**:
  - Must not interrupt the system while working
  - Should keep records of what it cleaned up

### 6. Report Card (Stats Tracking)
- **What it is**: A way to see how well the system is working
- **How it works**:
  - Counts important things:
    - How many questions were asked
    - How many were answered by computer vs. humans
    - How often human workers accepted the computer's suggestions
    - How long it took to answer each question
  - Shows these numbers in simple charts and tables
- **Requirements**:
  - Must be easy to understand for non-tech people
  - Should show comparisons (like this week vs. last week)
  - Response time tracking: full conversation cycle (citizen question â†’ final response)
  - Ideally should use Langfuse or Supabase (future: Metabase integration)

## How Everything Works Together

### Step 1: Filling the Library
1. A human uploads documents through the dashboard
2. External systems send documents via the Document Ingestion API

### Step 2: Answering Questions (Autopilot Mode)
1. Citizen types question in the chat window
2. System finds relevant information in the library
3. Asks Gemini to write an answer
4. Sends the answer back to the citizen immediately

### Step 3: Answering Questions (Assisted Mode)
1. Citizen types question in the chat window
2. System does the same search and asks the AI for a suggestion
3. Shows the suggestion to a human worker in the dashboard
4. Worker clicks SEND AS IS, or FIX IT, or WRITE MY OWN
5. System sends the worker's final answer to the citizen

### Step 4: Keeping Things Running
1. Cleanup Crew runs weekly to remove old stuff
2. Report Card always counts what happens
3. Everything runs on Vilnius city's servers except asking the AI

## Technical Implementation Details

### Database & Storage
- **Database**: Supabase (PostgreSQL backend)
- **Vector Database**: Chroma (embedded, persistent storage)
- **Authentication**: Simple username/password system (upgrade to Supabase Auth later)
- **Session handling**: Server-side sessions with cookies
- **Data retention**: Only statistics and conversations of past few days are critical

### AI & Embeddings
- **LLM**: Gemini 2.5 Flash via OpenRouter (fallback model configurable via env)
- **Vector Database**: Chroma for document embeddings and similarity search
- **Embeddings**: Chroma's built-in models or configurable external (Mistral-embed)
- **Document processing**: Character-based chunking that never breaks mid-sentence (chunk size configurable via env)
- **Retrieval**: k=150 most relevant chunks per query via Chroma similarity search

### Real-time Communication
- **Method**: Server-Sent Events (SSE) for status updates and receiving messages
- **Message sending**: Standard HTTP POST requests
- **Chat persistence**: Browser session only - conversations reset on page reload

### Widget Deployment
- **Method**: iframe embedding
- **Security**: Configurable domain allowlist (default: allow all)
- **Integration**: Single line of code like YouTube embed
- **Styling**: Hardcoded for now (future: env variables for customization)

### APIs & Integration
- **Document ingestion**: REST API with API key authentication (env variable)
- **External data**: Accept documents via API (Siurblys will be separate project)
- **Worker assignment**: Round-robin to online workers, auto-reassign after 30min timeout
- **File formats**: .docx, .txt, .rtf uploads via dashboard

### System Controls
- **Autopilot toggle**: Any worker can enable/disable system-wide
- **Dashboard access**: Single permission level for all workers
- **Document versioning**: Replace old versions, no history kept
- **Ticket visibility**: All workers see all tickets, assigned tickets highlighted (different color + filter option)
- **Worker status**: Activity-based online detection (30min timeout for reassignment)
- **Conversation limits**: No message limits or conversation length restrictions
- **Autopilot override**: Workers can send follow-up corrections to autopilot responses

## Important Rules

### Must Be Simple
- One single program that does everything (not many small programs)
- Easy for city workers to install and use
- No complicated setup needed
- Only statistics and conversations of the past few days are crucial data to be kept at all times, so you need to store them more independently

### Must Be Secure
- Only authorized people can see the dashboard
- All citizen information stays on city computers
- Only the AI answers and embeddings come from the internet
- Document API requires API key authentication

## What of This Is on City's Computers?
EVERYTHING except the actual AI brain that writes answers:
- Chat window
- Worker dashboard
- Information library
- Document ingestion API
- Cleanup crew
- Report card
- All data and conversations

The AI (Gemini) and embeddings (Mistral) live on the internet and we just send them questions and get back answers.

