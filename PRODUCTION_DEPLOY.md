# Production Deployment Guide

Quick reference for deploying Lizdeika to production.

## Prerequisites

- Docker & Docker Compose installed
- Domain name (optional, can use IP)
- API keys: OpenRouter, Mistral, ChromaDB

## Quick Deploy

```bash
# 1. Clone and navigate
git clone https://github.com/simonaszilinskas/lizdeika.git
cd lizdeika

# 2. Configure environment
cp .env.template .env

# 3. Generate security secrets (automated)
./scripts/generate-secrets.sh

# 4. Add your API keys
nano .env  # Add SITE_URL, OpenRouter, Mistral, ChromaDB keys

# 5. Deploy
docker compose -f docker-compose.prod.yml up -d

# 6. Verify
curl http://localhost/health
```

## Required Environment Variables

### Automated Secret Generation (Recommended)

Use the provided script to automatically generate all security secrets:

```bash
./scripts/generate-secrets.sh
```

This script will:
- Generate all 4 required secrets (JWT, refresh, TOTP, recovery)
- Update your `.env` file automatically
- Create a backup before making changes
- Prevent accidental overwrites of existing secrets

### Manual Configuration

After running the script, edit `.env` and add these required values:

```bash
# **CRITICAL**: SITE_URL is REQUIRED in production (app will not start without it)
# Must match your deployed URL (used for AI API HTTP-Referer headers)
SITE_URL=https://yourdomain.com  # or http://your-vps-ip for staging

# Frontend URL (usually same as SITE_URL)
FRONTEND_URL=https://yourdomain.com

# Database (use strong random password)
DB_PASSWORD=your_secure_random_password_here

# AI Services (obtain from providers)
OPENROUTER_API_KEY=sk-or-v1-your-key
MISTRAL_API_KEY=your-mistral-key

# Vector Database (obtain from ChromaDB Cloud)
CHROMA_URL=https://api.trychroma.com
CHROMA_TENANT=your-tenant-id
CHROMA_DATABASE=your-db-name
CHROMA_API_KEY=your-chroma-key

# Security secrets (auto-generated by script above)
# JWT_SECRET=...
# JWT_REFRESH_SECRET=...
# TOTP_ENCRYPTION_KEY=...
# ADMIN_RECOVERY_KEY=...
```

**Note**: Security secrets are auto-generated by `scripts/generate-secrets.sh`. Only set these manually if you cannot run the script.

## SSL/HTTPS Setup (Recommended)

### Option 1: Let's Encrypt (Automatic)

```bash
# Install certbot
sudo apt install certbot python3-certbot-nginx

# Get certificate
sudo certbot --nginx -d yourdomain.com

# Certificates auto-renew
```

### Option 2: Custom Certificates

Place certificates in `docker/nginx/ssl/`:
- `cert.pem` - Certificate
- `key.pem` - Private key

Then use `docker-compose.prod.yml` (already configured for SSL).

## Access URLs

After deployment:

- **Homepage**: `http://your-domain/`
- **Login**: `http://your-domain/login.html`
- **Agent Dashboard**: `http://your-domain/agent-dashboard.html`
- **Settings**: `http://your-domain/settings.html`
- **API Docs**: `http://your-domain/docs`
- **Health Check**: `http://your-domain/health`

## Post-Deployment

```bash
# Create first admin user (optional - can register via UI)
docker compose -f docker-compose.prod.yml exec backend npm run db:seed

# Default credentials (CHANGE IMMEDIATELY)
# Email: admin@lizdeika.lt
# Password: admin123
```

## Management

```bash
# View logs
docker compose -f docker-compose.prod.yml logs -f

# Restart
docker compose -f docker-compose.prod.yml restart

# Stop
docker compose -f docker-compose.prod.yml down

# Update to latest
git pull
docker compose -f docker-compose.prod.yml up -d --build
```

## Migrating from Previous Versions

### ⚠️ SITE_URL Now Required (v1.1+)

If updating from an older version, you **must** add `SITE_URL` to your `.env` file:

```bash
# 1. Stop containers
docker compose -f docker-compose.prod.yml down

# 2. Add SITE_URL to .env
echo "SITE_URL=https://yourdomain.com" >> .env
# or for staging: SITE_URL=http://your-vps-ip

# 3. Restart
docker compose -f docker-compose.prod.yml up -d
```

**Why is this required?**
- Used for HTTP-Referer headers in AI API calls
- Required by production environment validation
- Ensures URL consistency across the application

**Startup will fail with this error if not set:**
```
Error: Missing critical environment variables: SITE_URL
```

## Backup

```bash
# Database backup
docker compose -f docker-compose.prod.yml exec postgres \
  pg_dump -U lizdeika_user lizdeika_support > backup-$(date +%Y%m%d).sql

# Restore
cat backup.sql | docker compose -f docker-compose.prod.yml exec -T postgres \
  psql -U lizdeika_user lizdeika_support
```

## Troubleshooting

**Port 80/443 in use?**
```bash
sudo lsof -i :80
sudo systemctl stop apache2  # or nginx, if installed separately
```

**Check logs for errors:**
```bash
docker compose -f docker-compose.prod.yml logs backend --tail=100
```

**Reset everything:**
```bash
docker compose -f docker-compose.prod.yml down -v  # WARNING: Deletes data!
docker compose -f docker-compose.prod.yml up -d --build
```

## Security Checklist

- [ ] **Run `./scripts/generate-secrets.sh` to create secure secrets**
- [ ] **Set `SITE_URL` to your production domain (REQUIRED)**
- [ ] Change default admin password (`admin@lizdeika.lt` / `admin123`)
- [ ] Set strong `DB_PASSWORD` in `.env`
- [ ] Add API keys (OpenRouter, Mistral, ChromaDB)
- [ ] Enable SSL/HTTPS (Let's Encrypt recommended)
- [ ] Set `WIDGET_ALLOWED_DOMAINS` to specific domains (not `*`)
- [ ] Configure firewall (allow only 80, 443, 22)
- [ ] Schedule regular database backups
- [ ] Keep Docker images updated

## Environment-Specific URLs

All URLs now use `window.location.origin` - automatically adapts to:
- Development: `http://localhost:3002`
- Staging: `http://your-staging-ip`
- Production: `https://yourdomain.com`

No hardcoded URLs - deploy anywhere without code changes.

## Performance Tuning

Adjust in `docker-compose.prod.yml`:

```yaml
deploy:
  resources:
    limits:
      memory: 1G  # Increase for high traffic
```

## Support

- Issues: https://github.com/simonaszilinskas/lizdeika/issues
- Docs: See `README.md` and `CLAUDE.md`
